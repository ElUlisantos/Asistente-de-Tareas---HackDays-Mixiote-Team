<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Task Assistant Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#3B82F6",
                        "background-light": "#F3F4F6",
                        "background-dark": "#111827",
                        "surface-light": "#FFFFFF",
                        "surface-dark": "#1F2937",
                        "text-primary-light": "#111827",
                        "text-primary-dark": "#F9FAFB",
                        "text-secondary-light": "#6B7280",
                        "text-secondary-dark": "#9CA3AF",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                        sans: ["Inter", "sans-serif"],
                    }
                },
            },
        };
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-sans text-text-primary-light dark:text-text-primary-dark transition-colors duration-200 min-h-screen flex flex-col relative">
    
    <nav class="bg-surface-light dark:bg-surface-dark border-b border-gray-200 dark:border-gray-700 shadow-sm sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <span class="material-icons-outlined text-primary text-3xl mr-2">task_alt</span>
                        <h1 class="text-xl font-bold tracking-tight">TaskFlow</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 transition-colors">
                        <span id="theme-icon" class="material-icons-outlined">dark_mode</span>
                    </button>
                    <button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 transition-colors">
                        <span class="material-icons-outlined">notifications</span>
                    </button>
                    
                    <div class="relative">
                        <button id="user-menu-btn" class="flex items-center focus:outline-none rounded-full ring-2 ring-transparent hover:ring-primary transition-all">
                            <div id="user-avatar" class="h-8 w-8 rounded-full bg-primary flex items-center justify-center text-white font-medium transition-colors">JD</div>
                        </button>
                        
                        <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-surface-light dark:bg-surface-dark rounded-md shadow-lg border border-gray-200 dark:border-gray-700 py-1 z-20 transform origin-top-right transition-all">
                            <div id="user-info-section" class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                                <p class="text-sm font-medium text-text-primary-light dark:text-text-primary-dark">John Doe</p>
                                <p class="text-xs text-text-secondary-light dark:text-text-secondary-dark truncate">john.doe@example.com</p>
                            </div>
                            <div class="py-1">
                                <a href="#" id="login-btn" class="hidden px-4 py-2 text-sm text-text-primary-light dark:text-text-primary-dark hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors flex items-center">
                                    <span class="material-icons-outlined text-[18px] mr-2">login</span> Iniciar sesi√≥n
                                </a>
                                <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors flex items-center">
                                    <span class="material-icons-outlined text-[18px] mr-2">logout</span> Cerrar sesi√≥n
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col lg:flex-row gap-6 h-full">
            
            <div class="flex-grow lg:w-2/3 xl:w-3/4 flex flex-col gap-6">
                <div class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 flex-grow p-6 flex flex-col">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold">Calendario</h2>
                        <div class="flex items-center space-x-2">
                            <button id="prev-btn" class="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-text-secondary-light dark:text-text-secondary-dark transition-colors">
                                <span class="material-icons-outlined">chevron_left</span>
                            </button>
                            <span id="current-date-display" class="text-lg font-medium w-40 text-center">Month Year</span>
                            <button id="next-btn" class="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-text-secondary-light dark:text-text-secondary-dark transition-colors">
                                <span class="material-icons-outlined">chevron_right</span>
                            </button>
                            
                            <div class="ml-4 flex rounded-md bg-gray-100 dark:bg-gray-800 p-1 text-sm font-medium">
                                <button id="view-month-btn" class="rounded px-3 py-1 bg-surface-light dark:bg-surface-dark shadow-sm text-text-primary-light dark:text-text-primary-dark transition-all">Month</button>
                                <button id="view-week-btn" class="rounded px-3 py-1 text-text-secondary-light dark:text-text-secondary-dark hover:text-text-primary-light dark:hover:text-text-primary-dark transition-all">Week</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-px bg-gray-200 dark:bg-gray-700 rounded-t-lg overflow-hidden border-x border-t border-gray-200 dark:border-gray-700">
                        <div class="bg-surface-light dark:bg-surface-dark py-2 text-center text-sm font-semibold text-text-secondary-light dark:text-text-secondary-dark">Mon</div>
                        <div class="bg-surface-light dark:bg-surface-dark py-2 text-center text-sm font-semibold text-text-secondary-light dark:text-text-secondary-dark">Tue</div>
                        <div class="bg-surface-light dark:bg-surface-dark py-2 text-center text-sm font-semibold text-text-secondary-light dark:text-text-secondary-dark">Wed</div>
                        <div class="bg-surface-light dark:bg-surface-dark py-2 text-center text-sm font-semibold text-text-secondary-light dark:text-text-secondary-dark">Thu</div>
                        <div class="bg-surface-light dark:bg-surface-dark py-2 text-center text-sm font-semibold text-text-secondary-light dark:text-text-secondary-dark">Fri</div>
                        <div class="bg-surface-light dark:bg-surface-dark py-2 text-center text-sm font-semibold text-text-secondary-light dark:text-text-secondary-dark">Sat</div>
                        <div class="bg-surface-light dark:bg-surface-dark py-2 text-center text-sm font-semibold text-text-secondary-light dark:text-text-secondary-dark">Sun</div>
                    </div>
                    
                    <div id="calendar-grid" class="grid grid-cols-7 gap-px bg-gray-200 dark:bg-gray-700 rounded-b-lg overflow-hidden border border-gray-200 dark:border-gray-700 flex-grow auto-rows-fr">
                        </div>
                </div>
            </div>

            <div class="lg:w-1/3 xl:w-1/4 flex flex-col space-y-6">
                <div class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 flex flex-col flex-1 max-h-[50vh]">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">Lista</h3>
                        <span class="text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 px-2 py-1 rounded-full" id="task-counter">0 Tareas</span>
                    </div>
                    
                    <ul id="task-list" class="flex-grow space-y-3 mb-6 overflow-y-auto pr-2">
                        <li class="text-center text-text-secondary-light dark:text-text-secondary-dark text-sm mt-4">No hay tareas programadas.</li>
                    </ul>
                    
                    <button id="btn-create-task" class="w-full bg-primary hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center transition-colors shadow-md shadow-blue-500/20 mt-auto">
                        <span class="material-icons-outlined mr-2">add</span> Crear Tarea
                    </button>
                </div>

                <div class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xl font-bold">Resumen Semanal</h3>
                        <span class="text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">Carga</span>
                    </div>
                    <p class="text-xs text-text-secondary-light dark:text-text-secondary-dark mb-6">Tareas programadas por d√≠a de la semana actual.</p>
                    
                    <div id="weekly-chart" class="h-40 flex items-end justify-between space-x-1 sm:space-x-2">
                        </div>
                </div>
            </div>
        </div>
    </main>

    <div id="event-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-xl p-6 w-96 max-w-[90%] border border-gray-200 dark:border-gray-700 transform transition-all">
            <h3 class="text-xl font-bold mb-4" id="modal-title">Nueva Tarea</h3>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-medium mb-1 text-text-secondary-light dark:text-text-secondary-dark">T√≠tulo</label>
                    <input type="text" id="event-title" placeholder="Ej. Entregar reporte..." class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-transparent focus:ring-2 focus:ring-primary outline-none transition-all">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1 text-text-secondary-light dark:text-text-secondary-dark">Descripci√≥n</label>
                    <textarea id="event-desc" rows="3" placeholder="Detalles de la tarea..." class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-transparent focus:ring-2 focus:ring-primary outline-none transition-all resize-none"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1 text-text-secondary-light dark:text-text-secondary-dark">Fecha</label>
                    <input type="date" id="event-date" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-transparent focus:ring-2 focus:ring-primary outline-none transition-all [color-scheme:light] dark:[color-scheme:dark]">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2 text-text-secondary-light dark:text-text-secondary-dark">Color de etiqueta</label>
                    <div class="flex space-x-3" id="color-picker">
                        <button type="button" data-color="blue" class="w-8 h-8 rounded-full bg-blue-500 ring-2 ring-offset-2 ring-blue-500 dark:ring-offset-surface-dark transition-all"></button>
                        <button type="button" data-color="green" class="w-8 h-8 rounded-full bg-green-500 hover:ring-2 ring-offset-2 ring-green-500 dark:ring-offset-surface-dark transition-all opacity-70 hover:opacity-100"></button>
                        <button type="button" data-color="red" class="w-8 h-8 rounded-full bg-red-500 hover:ring-2 ring-offset-2 ring-red-500 dark:ring-offset-surface-dark transition-all opacity-70 hover:opacity-100"></button>
                        <button type="button" data-color="purple" class="w-8 h-8 rounded-full bg-purple-500 hover:ring-2 ring-offset-2 ring-purple-500 dark:ring-offset-surface-dark transition-all opacity-70 hover:opacity-100"></button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center border-t border-gray-200 dark:border-gray-700 pt-4">
                <button id="delete-event-btn" class="hidden px-3 py-2 rounded-lg text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors font-medium flex items-center">
                    <span class="material-icons-outlined text-[18px] mr-1">delete</span> Eliminar
                </button>
                <div class="flex space-x-3 ml-auto">
                    <button id="close-modal-btn" class="px-4 py-2 rounded-lg text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors font-medium">Cancelar</button>
                    <button id="save-event-btn" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-blue-600 transition-colors shadow-md font-medium">Guardar Tarea</button>
                </div>
            </div>
        </div>
    </div>

    <div id="global-tooltip" class="fixed hidden bg-surface-light dark:bg-surface-dark border border-gray-200 dark:border-gray-700 shadow-2xl rounded-lg p-3 z-[100] w-64 pointer-events-none transition-opacity duration-200 opacity-0">
        <div class="flex items-center mb-1">
            <span id="tooltip-color" class="w-3 h-3 rounded-full mr-2"></span>
            <h4 id="tooltip-title" class="font-bold text-sm text-text-primary-light dark:text-text-primary-dark truncate"></h4>
        </div>
        <p id="tooltip-desc" class="text-xs text-text-secondary-light dark:text-text-secondary-dark whitespace-pre-wrap mt-2"></p>
        <p id="tooltip-date" class="text-[10px] text-gray-400 mt-3 uppercase tracking-wide font-semibold border-t border-gray-200 dark:border-gray-700 pt-2"></p>
    </div>

    <script>
        // --- 1. MODO OSCURO ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');

        function updateThemeIcon() {
            themeIcon.textContent = document.documentElement.classList.contains('dark') ? 'light_mode' : 'dark_mode';
        }

        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        updateThemeIcon();

        themeToggleBtn.addEventListener('click', function() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            updateThemeIcon();
        });

        // --- 2. L√ìGICA DEL MEN√ö DE USUARIO ---
        const userMenuBtn = document.getElementById('user-menu-btn');
        const userDropdown = document.getElementById('user-dropdown');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userAvatar = document.getElementById('user-avatar');
        const userInfoSection = document.getElementById('user-info-section');

        let isLoggedIn = true; 

        function updateAuthUI() {
            if (isLoggedIn) {
                userAvatar.textContent = "JD";
                userAvatar.classList.remove("bg-gray-400", "dark:bg-gray-600");
                userAvatar.classList.add("bg-primary");
                userInfoSection.classList.remove("hidden");
                loginBtn.classList.add("hidden");
                logoutBtn.classList.remove("hidden");
            } else {
                userAvatar.textContent = "?";
                userAvatar.classList.remove("bg-primary");
                userAvatar.classList.add("bg-gray-400", "dark:bg-gray-600");
                userInfoSection.classList.add("hidden");
                loginBtn.classList.remove("hidden");
                logoutBtn.classList.add("hidden");
            }
        }

        userMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            userDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                userDropdown.classList.add('hidden');
            }
        });

        loginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isLoggedIn = true;
            updateAuthUI();
            userDropdown.classList.add('hidden');
        });

        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isLoggedIn = false;
            updateAuthUI();
            userDropdown.classList.add('hidden');
        });

        updateAuthUI(); 

        // --- 3. ESTADO GLOBAL DE TAREAS Y LOCALSTORAGE ---
        let currentDate = new Date(); 
        let currentView = 'month'; 
        let selectedColor = 'blue';
        
        // üíæ NUEVO: Cargar tareas guardadas al iniciar la p√°gina
        let tasks = JSON.parse(localStorage.getItem('taskflow_tasks')) || []; 
        let editingTaskId = null; 

        // üíæ NUEVO: Funci√≥n para guardar permanentemente
        function guardarTareasLocalmente() {
            localStorage.setItem('taskflow_tasks', JSON.stringify(tasks));
        }

        function formatDateString(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        function getTodayString() {
            return formatDateString(new Date());
        }

        function updateDashboard() {
            renderCalendar();
            renderTaskList();
            renderChart();
        }

        // --- 4. L√ìGICA DEL CALENDARIO ---
        const calendarGrid = document.getElementById('calendar-grid');
        const displayDate = document.getElementById('current-date-display');

        function renderCalendar() {
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            displayDate.textContent = currentView === 'month' ? `${monthNames[month]} ${year}` : `Week of ${monthNames[month]} ${year}`;

            let daysToRender = [];

            if (currentView === 'month') {
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const daysInPrevMonth = new Date(year, month, 0).getDate();
                
                const startOffset = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;

                for (let i = startOffset - 1; i >= 0; i--) {
                    daysToRender.push({ dateObj: new Date(year, month - 1, daysInPrevMonth - i), isCurrentMonth: false });
                }
                for (let i = 1; i <= daysInMonth; i++) {
                    daysToRender.push({ dateObj: new Date(year, month, i), isCurrentMonth: true });
                }
                const remainingCells = 42 - daysToRender.length;
                for (let i = 1; i <= remainingCells; i++) {
                    daysToRender.push({ dateObj: new Date(year, month + 1, i), isCurrentMonth: false });
                }
            } else if (currentView === 'week') {
                const currentDayOfWeek = currentDate.getDay();
                const startOffset = currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1;
                
                let startOfWeek = new Date(currentDate);
                startOfWeek.setDate(currentDate.getDate() - startOffset);

                for (let i = 0; i < 7; i++) {
                    let dateIter = new Date(startOfWeek);
                    dateIter.setDate(startOfWeek.getDate() + i);
                    daysToRender.push({ 
                        dateObj: dateIter,
                        isCurrentMonth: dateIter.getMonth() === month 
                    });
                }
            }

            const todayStr = getTodayString();

            daysToRender.forEach(info => {
                const dateStr = formatDateString(info.dateObj);
                const isToday = todayStr === dateStr;

                const dayDiv = document.createElement('div');
                dayDiv.className = `bg-surface-light dark:bg-surface-dark min-h-[100px] p-2 relative group hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors cursor-pointer flex flex-col gap-1 ${!info.isCurrentMonth && currentView === 'month' ? 'opacity-50' : ''}`;
                
                let dayNumberHtml = `<span class="font-medium text-sm w-7 h-7 flex items-center justify-center ${isToday ? 'bg-primary text-white rounded-full shadow-md' : 'text-text-primary-light dark:text-text-primary-dark'}">${info.dateObj.getDate()}</span>`;
                dayDiv.innerHTML = dayNumberHtml;

                const dayTasks = tasks.filter(t => t.date === dateStr);
                
                dayTasks.forEach(task => {
                    const evtDiv = document.createElement('div');
                    evtDiv.className = `px-2 py-1 text-xs font-medium rounded truncate bg-${task.color}-100 dark:bg-${task.color}-900 text-${task.color}-800 dark:text-${task.color}-200 shadow-sm relative transition-all duration-200 hover:scale-[1.03] hover:shadow-md hover:z-20 border border-transparent hover:border-${task.color}-300 cursor-pointer`;
                    evtDiv.textContent = task.title;

                    evtDiv.addEventListener('mouseenter', () => {
                        const tooltip = document.getElementById('global-tooltip');
                        document.getElementById('tooltip-title').textContent = task.title;
                        document.getElementById('tooltip-color').className = `w-3 h-3 rounded-full mr-2 bg-${task.color}-500`;
                        document.getElementById('tooltip-date').textContent = task.date;
                        
                        const descEl = document.getElementById('tooltip-desc');
                        if(task.desc) {
                            descEl.textContent = task.desc;
                            descEl.classList.remove('hidden');
                        } else {
                            descEl.classList.add('hidden');
                        }

                        const rect = evtDiv.getBoundingClientRect();
                        let leftPos = rect.left + (rect.width / 2) - 128; 
                        if (leftPos < 10) leftPos = 10;
                        if (leftPos + 260 > window.innerWidth) leftPos = window.innerWidth - 270;

                        let topPos = rect.bottom + 10;
                        if (rect.bottom + 150 > window.innerHeight) {
                            topPos = rect.top - 120; 
                        }

                        tooltip.style.left = `${leftPos}px`;
                        tooltip.style.top = `${topPos}px`;
                        
                        tooltip.classList.remove('hidden');
                        setTimeout(() => tooltip.classList.remove('opacity-0'), 10);
                    });

                    evtDiv.addEventListener('mouseleave', () => {
                        const tooltip = document.getElementById('global-tooltip');
                        tooltip.classList.add('opacity-0');
                        tooltip.classList.add('hidden'); 
                    });

                    evtDiv.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openModal(dateStr, task.id);
                    });

                    dayDiv.appendChild(evtDiv);
                });

                dayDiv.addEventListener('click', () => openModal(dateStr));
                calendarGrid.appendChild(dayDiv);
            });
        }

        // --- 5. L√ìGICA DE LA LISTA DE TAREAS ---
        const taskListEl = document.getElementById('task-list');
        const taskCounterEl = document.getElementById('task-counter');

        function renderTaskList() {
            taskListEl.innerHTML = '';
            const sortedTasks = [...tasks].sort((a, b) => new Date(a.date) - new Date(b.date));
            taskCounterEl.textContent = `${sortedTasks.length} Tareas`;

            if (sortedTasks.length === 0) {
                taskListEl.innerHTML = '<li class="text-center text-text-secondary-light dark:text-text-secondary-dark text-sm mt-4">No hay tareas programadas.</li>';
                return;
            }

            sortedTasks.forEach(task => {
                const li = document.createElement('li');
                li.className = `flex items-start p-3 rounded-lg bg-gray-50 dark:bg-gray-800/50 hover:bg-gray-100 dark:hover:bg-gray-800 group border border-transparent hover:border-gray-200 dark:hover:border-gray-700 transition-all border-l-4 border-l-${task.color}-500`;
                
                li.innerHTML = `
                    <div class="flex items-center h-5 mt-0.5">
                        <input type="checkbox" class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary dark:bg-gray-700 dark:border-gray-600 cursor-pointer"/>
                    </div>
                    <div class="ml-3 text-sm flex-grow cursor-pointer task-text-container" data-id="${task.id}">
                        <label class="font-medium text-text-primary-light dark:text-text-primary-dark cursor-pointer break-words pointer-events-none">${task.title}</label>
                        ${task.desc ? `<p class="text-text-secondary-light dark:text-text-secondary-dark text-xs mt-1 truncate max-w-[200px] pointer-events-none">${task.desc}</p>` : ''}
                        <p class="text-${task.color}-600 dark:text-${task.color}-400 text-xs font-medium mt-1 pointer-events-none">
                            <span class="material-icons-outlined text-[12px] align-middle mr-0.5 pointer-events-none">event</span>${task.date}
                        </p>
                    </div>
                `;
                
                const checkbox = li.querySelector('input');
                const label = li.querySelector('label');
                checkbox.addEventListener('change', (e) => {
                    if(e.target.checked) {
                        label.classList.add('line-through', 'text-gray-400');
                    } else {
                        label.classList.remove('line-through', 'text-gray-400');
                    }
                });

                const textContainer = li.querySelector('.task-text-container');
                textContainer.addEventListener('click', () => {
                    openModal('', task.id);
                });

                taskListEl.appendChild(li);
            });
        }

        // --- 6. L√ìGICA DE LA GR√ÅFICA SEMANAL ---
        const chartContainer = document.getElementById('weekly-chart');

        function renderChart() {
            chartContainer.innerHTML = '';
            const dayOfWeek = currentDate.getDay(); 
            const startOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            let startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - startOffset);
            
            const dayNames = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
            let weekData = [];
            let maxCount = 0;

            for (let i = 0; i < 7; i++) {
                let iterDate = new Date(startOfWeek);
                iterDate.setDate(startOfWeek.getDate() + i);
                let dateStr = formatDateString(iterDate);
                
                let count = tasks.filter(t => t.date === dateStr).length;
                if (count > maxCount) maxCount = count;
                
                weekData.push({ 
                    label: dayNames[i], 
                    dateNum: iterDate.getDate(), 
                    count: count,
                    isToday: dateStr === getTodayString()
                });
            }

            if (maxCount === 0) maxCount = 1; 
            const minHeightPercent = 10; 

            weekData.forEach(day => {
                let heightPercent = (day.count / maxCount) * 100;
                if (day.count === 0) heightPercent = minHeightPercent;

                const isPrimary = day.isToday;
                const barColorClass = isPrimary ? 'bg-primary group-hover:bg-blue-600' : 'bg-blue-200 dark:bg-blue-900 group-hover:bg-blue-300 dark:group-hover:bg-blue-800';
                const textColorClass = isPrimary ? 'text-primary font-bold' : 'text-text-secondary-light dark:text-text-secondary-dark font-medium';

                const barHtml = `
                    <div class="flex flex-col items-center flex-1 group h-full justify-end cursor-pointer">
                        <div class="relative w-full flex justify-center h-[120px] items-end">
                            <div class="w-full max-w-[24px] ${barColorClass} rounded-t-md transition-all duration-300 relative flex items-start justify-center pt-1" style="height: ${heightPercent}%;">
                                ${day.count > 0 ? `<span class="text-[10px] font-bold text-white opacity-0 group-hover:opacity-100 transition-opacity absolute -top-5 text-gray-700 dark:text-gray-300">${day.count}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col items-center mt-2">
                            <span class="text-xs ${textColorClass}">${day.label}</span>
                            <span class="text-[10px] font-bold text-gray-400 dark:text-gray-500">${day.dateNum}</span>
                        </div>
                    </div>
                `;
                chartContainer.insertAdjacentHTML('beforeend', barHtml);
            });
        }

        // --- 7. CONTROLES Y MODAL ---
        const modal = document.getElementById('event-modal');
        const modalTitle = document.getElementById('modal-title');
        const titleInput = document.getElementById('event-title');
        const descInput = document.getElementById('event-desc');
        const dateInput = document.getElementById('event-date');
        const colorButtons = document.querySelectorAll('#color-picker button');
        const deleteEventBtn = document.getElementById('delete-event-btn');

        document.getElementById('prev-btn').addEventListener('click', () => {
            currentView === 'month' ? currentDate.setMonth(currentDate.getMonth() - 1) : currentDate.setDate(currentDate.getDate() - 7);
            updateDashboard();
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            currentView === 'month' ? currentDate.setMonth(currentDate.getMonth() + 1) : currentDate.setDate(currentDate.getDate() + 7);
            updateDashboard();
        });

        const viewMonthBtn = document.getElementById('view-month-btn');
        const viewWeekBtn = document.getElementById('view-week-btn');

        viewMonthBtn.addEventListener('click', () => {
            currentView = 'month';
            viewMonthBtn.className = "rounded px-3 py-1 bg-surface-light dark:bg-surface-dark shadow-sm text-text-primary-light dark:text-text-primary-dark transition-all";
            viewWeekBtn.className = "rounded px-3 py-1 text-text-secondary-light dark:text-text-secondary-dark hover:text-text-primary-light dark:hover:text-text-primary-dark transition-all cursor-pointer";
            updateDashboard();
        });

        viewWeekBtn.addEventListener('click', () => {
            currentView = 'week';
            viewWeekBtn.className = "rounded px-3 py-1 bg-surface-light dark:bg-surface-dark shadow-sm text-text-primary-light dark:text-text-primary-dark transition-all";
            viewMonthBtn.className = "rounded px-3 py-1 text-text-secondary-light dark:text-text-secondary-dark hover:text-text-primary-light dark:hover:text-text-primary-dark transition-all cursor-pointer";
            currentDate = new Date();
            updateDashboard();
        });

        function openModal(defaultDateStr = '', taskId = null) {
            editingTaskId = taskId; 
            
            if (taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    modalTitle.textContent = "Editar Tarea";
                    titleInput.value = task.title;
                    descInput.value = task.desc || '';
                    dateInput.value = task.date;
                    
                    colorButtons.forEach(b => {
                        b.classList.remove('ring-2', 'ring-offset-2', 'opacity-100');
                        b.classList.add('opacity-70', 'hover:opacity-100');
                        if (b.getAttribute('data-color') === task.color) {
                            b.classList.remove('opacity-70', 'hover:opacity-100');
                            b.classList.add('ring-2', 'ring-offset-2', 'opacity-100');
                            selectedColor = task.color;
                        }
                    });
                    
                    deleteEventBtn.classList.remove('hidden'); 
                }
            } else {
                modalTitle.textContent = "Nueva Tarea";
                titleInput.value = '';
                descInput.value = '';
                dateInput.value = defaultDateStr || getTodayString();
                deleteEventBtn.classList.add('hidden'); 
                
                selectedColor = 'blue';
                colorButtons.forEach(b => {
                    b.classList.remove('ring-2', 'ring-offset-2', 'opacity-100');
                    b.classList.add('opacity-70', 'hover:opacity-100');
                    if (b.getAttribute('data-color') === 'blue') {
                        b.classList.remove('opacity-70', 'hover:opacity-100');
                        b.classList.add('ring-2', 'ring-offset-2', 'opacity-100');
                    }
                });
            }
            
            modal.classList.remove('hidden');
            setTimeout(() => titleInput.focus(), 100);
        }

        document.getElementById('btn-create-task').addEventListener('click', () => openModal());
        document.getElementById('close-modal-btn').addEventListener('click', () => modal.classList.add('hidden'));

        colorButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                colorButtons.forEach(b => {
                    b.classList.remove('ring-2', 'ring-offset-2', 'opacity-100');
                    b.classList.add('opacity-70', 'hover:opacity-100');
                });
                const clicked = e.target;
                clicked.classList.remove('opacity-70', 'hover:opacity-100');
                clicked.classList.add('ring-2', 'ring-offset-2', 'opacity-100');
                selectedColor = clicked.getAttribute('data-color');
            });
        });

        deleteEventBtn.addEventListener('click', () => {
            if (editingTaskId) {
                tasks = tasks.filter(t => t.id !== editingTaskId);
                guardarTareasLocalmente(); // üíæ Guardar cambios
                modal.classList.add('hidden');
                updateDashboard();
            }
        });

        document.getElementById('save-event-btn').addEventListener('click', () => {
            const title = titleInput.value.trim();
            const desc = descInput.value.trim();
            const dateStr = dateInput.value;

            if (title && dateStr) {
                if (editingTaskId) {
                    const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
                    if (taskIndex !== -1) {
                        tasks[taskIndex].title = title;
                        tasks[taskIndex].desc = desc;
                        tasks[taskIndex].date = dateStr;
                        tasks[taskIndex].color = selectedColor;
                    }
                } else {
                    tasks.push({
                        id: Date.now(),
                        title: title,
                        desc: desc,
                        date: dateStr,
                        color: selectedColor
                    });
                }
                
                guardarTareasLocalmente(); // üíæ Guardar permanentemente
                modal.classList.add('hidden');
                updateDashboard();
            } else {
                alert("Por favor, ingresa al menos un t√≠tulo y una fecha.");
            }
        });

        // --- 8. INICIO ---
        updateDashboard();

       // --- 9. CONEXI√ìN CON TELEGRAM (CEREBRO LLAMA 3 + AUDIO WHISPER) ---
        const TELEGRAM_TOKEN = ''; 
        const GROQ_API_KEY = ''; 
        let lastUpdateId = 0; 

       // üß† El "Cerebro Supremo" impulsado por Llama 3 (A prueba de fallos)
        async function procesarMensajeConIA(textoOriginal) {
            const hoy = new Date();
            const fechaHoy = formatDateString(hoy);
            const dias = ["domingo", "lunes", "martes", "mi√©rcoles", "jueves", "viernes", "s√°bado"];
            const diaSemana = dias[hoy.getDay()];

            const prompt = `
            Eres un sistema de calendario automatizado. Hoy es ${diaSemana}, ${fechaHoy}.
            Extrae la tarea y la fecha del siguiente mensaje.
            
            Reglas:
            1. T√≠tulo: Quita el relleno conversacional ("Oye", "tengo un", "puedes agendar", "por favor"). Deja solo la acci√≥n (Ej. "Examen de mates").
            2. Fecha: Formato YYYY-MM-DD bas√°ndote en hoy. Si dice "pr√≥xima semana", s√∫male 7 d√≠as a hoy.
            3. Si no hay fecha, usa ${fechaHoy}.
            4. Color: "red" (examen/urgente), "purple" (estudio/tarea), "blue" (reuni√≥n), "green" (personal).
            
            Mensaje: "${textoOriginal}"
            
            Responde √öNICAMENTE con un JSON v√°lido. Cero texto extra. Cero markdown.
            Ejemplo exacto de lo que quiero: {"titulo": "Examen final", "fecha": "2026-03-07", "color": "red"}
            `;

            try {
                console.log("üß† Pensando con Llama 3...");
                
                // Si la llave de Groq est√° vac√≠a, forzamos el error para que te des cuenta
                if (GROQ_API_KEY.includes("PEGAR_AQUI")) throw new Error("¬°Falta la API Key de Groq!");

                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${GROQ_API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "llama-3.1-8b-instant", 
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.1
                    })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);

                // üßπ Filtro Anti-Basura: Quitamos los backticks (```json) por si la IA se pone rebelde
                let textoIA = data.choices[0].message.content;
                textoIA = textoIA.replace(/```json/gi, '').replace(/```/gi, '').trim();

                const jsonParseado = JSON.parse(textoIA);
                console.log("üéØ Llama 3 decidi√≥:", jsonParseado);
                
                return jsonParseado;
            } catch (error) {
                console.error("‚ùå Error l√≥gico en la IA:", error.message);
                // Plan B
                return { titulo: textoOriginal.substring(0, 30) + "...", fecha: fechaHoy, color: "blue" };
            }
        }

        // üó£Ô∏è Funci√≥n para responder en Telegram
        async function responderTelegram(chatId, mensaje) {
            const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: chatId, text: mensaje })
                });
            } catch (error) {
                console.error("Error al enviar respuesta:", error);
            }
        }

        // üéôÔ∏è Funci√≥n para transcribir audio (Whisper)
        async function transcribirAudio(fileUrl) {
            try {
                const proxyUrl = "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(fileUrl);
                const audioResponse = await fetch(proxyUrl);
                
                if (!audioResponse.ok) throw new Error("Proxy fall√≥");
                const audioBlob = await audioResponse.blob();
                
                if (audioBlob.size < 1000) return null;

                const formData = new FormData();
                formData.append("file", audioBlob, "mensaje.ogg"); 
                formData.append("model", "whisper-large-v3");
                formData.append("response_format", "json");
                formData.append("language", "es");

                const groqResponse = await fetch("https://api.groq.com/openai/v1/audio/transcriptions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${GROQ_API_KEY}` },
                    body: formData
                });

                const data = await groqResponse.json();
                return data.error ? null : data.text; 
            } catch (error) {
                return null;
            }
        }

        // üì° El Radar Principal
        async function escucharTelegram() {
            if (TELEGRAM_TOKEN === 'PEGAR_AQUI_TU_TOKEN') return; 

            try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/getUpdates?offset=${lastUpdateId + 1}`);
                const data = await response.json();

                if (data.ok && data.result.length > 0) {
                    for (const item of data.result) {
                        lastUpdateId = item.update_id; 
                        const chatId = item.message?.chat?.id;
                        let textoOriginal = "";
                        
                        if (item.message && item.message.text) {
                            textoOriginal = item.message.text;
                        } 
                        else if (item.message && item.message.voice) {
                            const fileId = item.message.voice.file_id;
                            const fileResponse = await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/getFile?file_id=${fileId}`);
                            const fileData = await fileResponse.json();
                            const downloadUrl = `https://api.telegram.org/file/bot${TELEGRAM_TOKEN}/${fileData.result.file_path}`;

                            await responderTelegram(chatId, "üéß Analizando audio...");
                            textoOriginal = await transcribirAudio(downloadUrl);
                            
                            if (!textoOriginal) {
                                await responderTelegram(chatId, "‚ùå El audio estaba borroso, no te entend√≠.");
                                continue;
                            }
                        }

                        if (textoOriginal && textoOriginal !== "") {
                            // ¬°Aqu√≠ le pasamos el texto al Cerebro Supremo Llama 3!
                            const datosExtraidos = await procesarMensajeConIA(textoOriginal);

                            tasks.push({
                                id: Date.now(),
                                title: datosExtraidos.titulo, 
                                desc: "ü§ñ " + textoOriginal, // Guardamos tu mensaje original como descripci√≥n para contexto
                                date: datosExtraidos.fecha,   
                                color: datosExtraidos.color 
                            });

                            guardarTareasLocalmente();
                            updateDashboard();

                            const mensajeConfirmacion = `‚úÖ Agendado:\nüìå ${datosExtraidos.titulo}\nüìÖ Fecha: ${datosExtraidos.fecha}`;
                            await responderTelegram(chatId, mensajeConfirmacion);
                        }
                    }
                }
            } catch (error) {
                console.error("Error del radar:", error);
            }
        }

        setInterval(escucharTelegram, 3000);
    </script>
</body>
</html>